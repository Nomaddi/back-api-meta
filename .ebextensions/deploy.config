option_settings:
    -
        namespace: aws:elasticbeanstalk:application:environment
        option_name: COMPOSER_HOME
        value: /root

    -
        namespace: aws:elasticbeanstalk:container:php:phpini
        option_name: document_root
        value: /public

container_commands:
    00_install_libzip:
        command: "sudo yum install -y libzip libzip-devel"
    01_install_php_zip_extension:
        command: "echo '' | sudo pecl install zip || true"
    02_enable_zip_extension:
        command: "echo 'extension=zip.so' | sudo tee /etc/php.d/50-zip.ini"
    03_install_composer_dependencies:
        command: "php -d memory_limit=-1 /usr/local/bin/composer install --no-dev --prefer-dist --optimize-autoloader --ignore-platform-req=ext-zip"
        cwd: "/var/app/staging"
    04_download_n:
        command: curl -L https://raw.githubusercontent.com/tj/n/master/bin/n -o /usr/local/bin/n
    05_make_n_executable:
        command: chmod +x /usr/local/bin/n
    06_install_specific_node:
        command: "/usr/local/bin/n 12.22.0"
    07_install_node_dependencies:
        command: "npm install"
        cwd: "/var/app/staging"
    08_compile_assets:
        command: "npm run production"
        cwd: "/var/app/staging"

files:
    /etc/cron.d/schedule_run:
        mode: "000644"
        owner: root
        group: root
        content: |
            */5 * * * * root . /opt/elasticbeanstalk/deployment/envvars && /usr/bin/php /var/www/html/artisan schedule:run 1>> /dev/null 2>&1
    /opt/elasticbeanstalk/tasks/taillogs.d/laravel-logs.conf:
        content: /var/app/current/storage/logs/laravel.log
        group: root
        mode: "000755"
        owner: root
    /etc/nginx/conf.d/proxy.conf:
        mode: "000755"
        owner: root
        group: root
        content: |
            client_header_timeout 300;
            client_body_timeout 300;
            keepalive_timeout 300;
            send_timeout 300;
            proxy_connect_timeout 300;
            proxy_send_timeout 300;
            proxy_read_timeout 300;
            fastcgi_send_timeout 300;
            fastcgi_read_timeout 300;
    /etc/php.ini:
        mode: "000755"
        owner: root
        group: root
        content: |
            max_execution_time = 300
            max_input_time = 300
            memory_limit = 512M
    /etc/systemd/system/laravel_worker@.service:
        mode: "000755"
        owner: root
        group: root
        content: |
            # Laravel queue worker using systemd
            # ----------------------------------
            #
            # /lib/systemd/system/queue.service
            #
            # run this command to enable service:
            # systemctl enable queue.service

            [Unit]
            Description=Laravel queue worker %i
            After=network.target

            [Service]
            User=nginx
            Group=nginx
            Restart=always
            RestartSec=3
            ExecStart=/usr/bin/php /var/www/html/artisan queue:work sqs --sleep=3 --tries=3

            [Install]
            WantedBy=multi-user.target
