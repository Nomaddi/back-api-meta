# .ebextensions/01_setup.config

packages:
    yum:
        zip: []
        libzip: []
        libzip-devel: []
        php8.2-zip: []

container_commands:
    # Crear el directorio de logs para php-fpm y el archivo error.log
    01_create_log_directory:
        command: "mkdir -p /var/log/php-fpm"
        ignoreErrors: true

    02_create_error_log:
        command: "touch /var/log/php-fpm/error.log && chown webapp:webapp /var/log/php-fpm/error.log"
        ignoreErrors: true

    # Eliminar la configuraci贸n duplicada de zip para evitar la advertencia de "Module zip is already loaded"
    03_remove_zip_extension_duplicate:
        command: "rm -f /etc/php.d/50-zip.ini"
        ignoreErrors: true

    # Instalar las dependencias de Composer
    04_install_composer_dependencies:
        command: "composer install --no-dev --prefer-dist --optimize-autoloader"
        cwd: "/var/app/staging"
        ignoreErrors: false

    # Establecer permisos en los directorios necesarios para Laravel
    05_set_permissions_storage:
        command: "chmod -R 775 /var/app/staging/storage /var/app/staging/bootstrap/cache"
        ignoreErrors: true

    06_adjust_owner_storage:
        command: "chown -R webapp:webapp /var/app/staging/storage /var/app/staging/bootstrap/cache"
        ignoreErrors: true

commands:
    # Configuraci贸n de permisos para el directorio de la aplicaci贸n en producci贸n
    07_set_permissions_current:
        command: "chmod -R 775 /var/app/current/storage /var/app/current/bootstrap/cache"
        ignoreErrors: true

    08_adjust_owner_current:
        command: "chown -R webapp:webapp /var/app/current/storage /var/app/current/bootstrap/cache"
        ignoreErrors: true
